#
# SPDX-FileCopyrightText: Â© 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : bash
version     : '5.2.32'
release     : 13
homepage    : http://www.gnu.org/software/bash/bash.html
upstreams   :
    - https://ftp.gnu.org/gnu/bash/bash-5.2.21.tar.gz : c8e31bdc59b69aaffc5b36509905ba3e5cbb12747091d27b4b977f078560d5b8
summary     : GNU Bourne-Again Shell
description : |
    Bash is a sh-compatible command interpreter that executes
    commands read from the standard input or from a file.
    Bash also incorporates useful features from the Korn and
    C shells (ksh and csh).  Bash is ultimately intended to
    be a conformant implementation of the IEEE Posix Shell
    and Tools specification (IEEE Working Group 1003.2)
license     :
    - GPL-3.0-or-later
builddeps   :
    - bison
    - pkgconfig(ncursesw)
    - pkgconfig(readline)
#environment : |
#    export CFLAGS="${CFLAGS} -mllvm -vp-counters-per-site=3"
setup       : |
    %patch %(pkgdir)/bash52-022 -p0
    %patch %(pkgdir)/bash52-023 -p0
    %patch %(pkgdir)/bash52-024 -p0
    %patch %(pkgdir)/bash52-025 -p0
    %patch %(pkgdir)/bash52-026 -p0
    %patch %(pkgdir)/bash52-027 -p0
    %patch %(pkgdir)/bash52-028 -p0
    %patch %(pkgdir)/bash52-029 -p0
    %patch %(pkgdir)/bash52-030 -p0
    %patch %(pkgdir)/bash52-031 -p0
    %patch %(pkgdir)/bash52-032 -p0

    %patch %(pkgdir)/stateless.patch

    # often hangs
    rm tests/run-jobs

    %configure \
        --without-bash-malloc \
        --with-installed-readline \
        --with-ncurses \
        --enable-readline \
        --enable-nls
build       : |
    %make
install     : |
    %bolt_instr ./bash
    # hangs with instrumented bash
    mv tests/run-ifs-posix ifs-posix
    mv tests/run-read run-read
    mv tests/run-redir run-redir
    %make check -k
    %bolt_merge ./bash
    %bolt_opt ./bash
    mv ifs-posix tests/run-ifs-posix
    mv run-read tests/run-read
    mv run-redir tests/run-redir

    %make_install
    %install_file %(pkgdir)/profile %(installroot)%(vendordir)%(sysconfdir)/profile
    %install_file %(pkgdir)/prompt.sh %(installroot)%(vendordir)%(sysconfdir)/profile.d/prompt.sh
    %install_file %(pkgdir)/bashrc %(installroot)%(vendordir)%(sysconfdir)/bashrc
    ln -svf bash "%(installroot)/usr/bin/sh"
#check       : |
#    %make check
workload    : |
    %make check
tuning      :
    - lto : full
    - bolt
